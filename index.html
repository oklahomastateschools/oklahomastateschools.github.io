<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Persistent Hypertab Browser</title>
	<style>
		body {
			background-color: #2e2e2e;
			color: white;
			font-family: Arial, sans-serif;
			margin: 0;
			padding: 0;
			display: flex; 
			flex-direction: column;
			height: 100vh;
		}

		#tabs-bar {
			background: #333;
			display: flex;
			align-items: center;
			padding: 5px;
			overflow-x: auto;
		}

		.tab {
			padding: 8px 12px;
			background: #444;
			margin-right: 4px;
			border-radius: 4px 4px 0 0;
			cursor: pointer;
			display: flex;
			align-items: center;
		}

		.tab.active {
			background: #666;
		}

		.tab span.close {
			margin-left: 8px;
			cursor: pointer;
			font-weight: bold;
		}

		#new-tab-button {
			background: #555;
			border: none;
			color: white;
			padding: 8px 12px;
			cursor: pointer;
			border-radius: 4px;
		}

		#tabs-content {
			flex: 1;
			display: flex;
			flex-direction: column;
			position: relative;
		}

		.tab-content {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			display: none;
			flex-direction: column;
		}

		.tab-content.active {
			display: flex;
		}

		.search-container {
			padding: 10px;
			background: #444;
			display: flex;
			gap: 10px;
		}

		.search-container input {
			flex: 1;
			padding: 8px;
			background: #555;
			border: none;
			color: white;
		}

		.search-container button {
			background: #666;
			color: white;
			border: none;
			padding: 8px 15px;
			cursor: pointer;
		}

		.content-frame {
			flex: 1;
			width: 100%;
			border: none;
		}
	</style>
</head>

<body>
	<div id="tabs-bar">
		<button id="new-tab-button" onclick="createNewTab()">New Tab</button>
	</div>
	<div id="tabs-content"></div>
	<script>
		let tabsData = [];
    let activeTabId = null;
    const tabsBar = document.getElementById("tabs-bar");
    const tabsContent = document.getElementById("tabs-content");

    function saveTabs() {
      localStorage.setItem("hypertabTabs", JSON.stringify(tabsData));
      localStorage.setItem("hypertabActiveTab", activeTabId);
    }

    function createTabDOM(tabId, url) {
      const tabHeader = document.createElement("div");
      tabHeader.classList.add("tab");
      tabHeader.id = "header-" + tabId;
      tabHeader.textContent = "New Tab";
      tabHeader.onclick = () => switchTab(tabId);
      const closeBtn = document.createElement("span");
      closeBtn.textContent = "Ã";
      closeBtn.classList.add("close");
      closeBtn.onclick = (e) => {
        e.stopPropagation();
        closeTab(tabId);
      };
      tabHeader.appendChild(closeBtn);
      tabsBar.insertBefore(tabHeader, document.getElementById("new-tab-button"));

      const tabContent = document.createElement("div");
      tabContent.classList.add("tab-content");
      tabContent.id = "content-" + tabId;
      const searchContainer = document.createElement("div");
      searchContainer.classList.add("search-container");
      const searchBar = document.createElement("input");
      searchBar.type = "text";
      searchBar.placeholder = "Enter URL";
      searchBar.id = "search-" + tabId;
      if (url) {
        searchBar.value = url;
      }
      const goButton = document.createElement("button");
      goButton.textContent = "Go";
      goButton.onclick = () => loadPage(tabId);
      searchContainer.appendChild(searchBar);
      searchContainer.appendChild(goButton);
      const iframe = document.createElement("iframe");
      iframe.classList.add("content-frame");
      iframe.id = "iframe-" + tabId;
      tabContent.appendChild(searchContainer);
      tabContent.appendChild(iframe);
      tabsContent.appendChild(tabContent);
      searchBar.addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
          loadPage(tabId);
        }
      });
      if (url) {
        loadPage(tabId);
      }
    }

    function createNewTab(url = "") {
      const tabId = "tab-" + Date.now() + "-" + Math.floor(Math.random() * 1000);
      createTabDOM(tabId, url);
      tabsData.push({ id: tabId, url: url });
      activeTabId = tabId;
      saveTabs();
      switchTab(tabId);
    }

    function switchTab(tabId) {
      const allTabHeaders = document.querySelectorAll(".tab");
      const allTabContents = document.querySelectorAll(".tab-content");
      allTabHeaders.forEach((tab) => tab.classList.remove("active"));
      allTabContents.forEach((content) => content.classList.remove("active"));
      const activeHeader = document.getElementById("header-" + tabId);
      const activeContent = document.getElementById("content-" + tabId);
      if (activeHeader && activeContent) {
        activeHeader.classList.add("active");
        activeContent.classList.add("active");
        activeTabId = tabId;
        saveTabs();
      }
    }

    function closeTab(tabId) {
      const header = document.getElementById("header-" + tabId);
      const content = document.getElementById("content-" + tabId);
      if (header) header.remove();
      if (content) content.remove();
      tabsData = tabsData.filter((tab) => tab.id !== tabId);
      if (activeTabId === tabId) {
        if (tabsData.length > 0) {
          const newActiveTabId = tabsData[tabsData.length - 1].id;
          switchTab(newActiveTabId);
        } else {
          activeTabId = null;
        }
      }
      saveTabs();
    }

    function loadPage(tabId) {
      const searchBar = document.getElementById("search-" + tabId);
      const iframe = document.getElementById("iframe-" + tabId);
      let query = searchBar.value.trim();
      if (query) {
        let encodedQuery = encodeURIComponent(query);
        iframe.src = `/static/iframe.html#https://${encodedQuery}`;
        const tabHeader = document.getElementById("header-" + tabId);
        let closeBtn = tabHeader.querySelector(".close");
        let displayText = query;
        try {
          // If the query does not include a protocol, assume https://
          let urlObject = new URL(query.startsWith("http") ? query : "https://" + query);
          displayText = urlObject.hostname;
        } catch (error) {
          displayText = query.length > 20 ? query.substring(0, 20) + "..." : query;
        }
        tabHeader.textContent = displayText;
        tabHeader.appendChild(closeBtn);
        const tabObj = tabsData.find((tab) => tab.id === tabId);
        if (tabObj) {
          tabObj.url = query;
        }
        saveTabs();
      }
    }

    function restoreTabs() {
      const storedTabs = localStorage.getItem("hypertabTabs");
      const storedActiveTab = localStorage.getItem("hypertabActiveTab");
      if (storedTabs) {
        tabsData = JSON.parse(storedTabs);
        tabsData.forEach((tab) => {
          createTabDOM(tab.id, tab.url);
        });
        if (storedActiveTab) {
          activeTabId = storedActiveTab;
          switchTab(activeTabId);
        } else if (tabsData.length) {
          activeTabId = tabsData[0].id;
          switchTab(activeTabId);
        }
      } else {
        createNewTab();
      } 
    }

    window.onload = function () {
      restoreTabs();
		createNewTab();
    };
</script>
</body>
 
</html>
